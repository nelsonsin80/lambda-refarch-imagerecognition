AWSTemplateFormatVersion: 2010-09-09

Parameters:
  env:
    Type: String
  authRoleArn:
    Type: String
  unauthRoleArn:
    Type: String

  identityPoolName:
    Type: String
  allowUnauthenticatedIdentities:
    Type: String
  resourceNameTruncated:
    Type: String
  userPoolName:
    Type: String
  autoVerifiedAttributes:
    Type: CommaDelimitedList
  mfaConfiguration:
    Type: String
  mfaTypes:
    Type: CommaDelimitedList
  smsAuthenticationMessage:
    Type: String
  smsVerificationMessage:
    Type: String
  emailVerificationSubject:
    Type: String
  emailVerificationMessage:
    Type: String
  defaultPasswordPolicy:
    Type: String
  passwordPolicyMinLength:
    Type: Number
  passwordPolicyCharacters:
    Type: CommaDelimitedList
  requiredAttributes:
    Type: CommaDelimitedList
  userpoolClientGenerateSecret:
    Type: String
  userpoolClientRefreshTokenValidity:
    Type: Number
  userpoolClientWriteAttributes:
    Type: CommaDelimitedList
  userpoolClientReadAttributes:
    Type: CommaDelimitedList
  userpoolClientLambdaRole:
    Type: String
  userpoolClientSetAttributes:
    Type: String
  resourceName:
    Type: String
  authSelections:
    Type: String
  useDefault:
    Type: String
  userPoolGroupList:
    Type: CommaDelimitedList
  dependsOn:
    Type: CommaDelimitedList

Conditions:
  ShouldNotCreateEnvResources: !Equals [ !Ref env, NONE ]

Resources:

  # ---------------------------------------------------------
  # SNS role used by Cognito SMS configuration (for MFA)
  # Name pattern: sns-<shortStackToken>-<env>-<shortGuid>
  # ---------------------------------------------------------
  # SNSRole:
  #   Type: AWS::IAM::Role
  #   Properties:
  #     RoleName: !Join
  #       - '-'
  #       - - 'sns'
  #         - !Select [3, !Split ['-', !Ref 'AWS::StackName']]
  #         - !Ref env
  #         - !Select
  #             - 0
  #             - !Split
  #               - '-'
  #               - !Select [3, !Split ['/', !Ref 'AWS::StackId']]
  #     AssumeRolePolicyDocument:
  #       Version: "2012-10-17"
  #       Statement:
  #         - Sid: ""
  #           Effect: "Allow"
  #           Principal:
  #             Service: "cognito-idp.amazonaws.com"
  #           Action:
  #             - "sts:AssumeRole"
  #           Condition:
  #             StringEquals:
  #               sts:ExternalId: photosb143529b_role_external_id
  #     Policies:
  #       - PolicyName: photosb143529b-sns-policy
  #         PolicyDocument:
  #           Version: "2012-10-17"
  #           Statement:
  #             - Effect: "Allow"
  #               Action:
  #                 - "sns:Publish"
  #               Resource: "*"

  SNSRole:
  Type: AWS::IAM::Role
  Properties:
    # Role name = "sns-<env>-<8char-guid-from-StackId>"
    RoleName: !Join
      - '-'
      - - 'sns'
        - !Ref env
        - !Select
            - 0
            - !Split
              - '-'
              - !Select
                - 2
                - !Split
                  - '/'
                  - !Ref 'AWS::StackId'
    AssumeRolePolicyDocument:
      Version: "2012-10-17"
      Statement:
        - Sid: ""
          Effect: "Allow"
          Principal:
            Service: "cognito-idp.amazonaws.com"
          Action:
            - "sts:AssumeRole"
          Condition:
            StringEquals:
              sts:ExternalId: photosb143529b_role_external_id
    Policies:
      - PolicyName: photosb143529b-sns-policy
        PolicyDocument:
          Version: "2012-10-17"
          Statement:
            - Effect: "Allow"
              Action:
                - "sns:Publish"
              Resource: "*"

  # ---------------------------------------------------------
  # User Pool and Clients
  # ---------------------------------------------------------
  UserPool:
    Type: AWS::Cognito::UserPool
    UpdateReplacePolicy: Retain
    Properties:
      UserPoolName: !If [ShouldNotCreateEnvResources, !Ref userPoolName, !Join ['',[!Ref userPoolName, '-', !Ref env]]]
      Schema:
        - Name: email
          Required: true
          Mutable: true
      AutoVerifiedAttributes: !Ref autoVerifiedAttributes
      EmailVerificationMessage: !Ref emailVerificationMessage
      EmailVerificationSubject: !Ref emailVerificationSubject
      Policies:
        PasswordPolicy:
          MinimumLength: !Ref passwordPolicyMinLength
          RequireLowercase: false
          RequireNumbers: false
          RequireSymbols: false
          RequireUppercase: false
      MfaConfiguration: !Ref mfaConfiguration
      SmsVerificationMessage: !Ref smsVerificationMessage
      SmsConfiguration:
        SnsCallerArn: !GetAtt SNSRole.Arn
        ExternalId: photosb143529b_role_external_id

  UserPoolClientWeb:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: photosb143529b_app_clientWeb
      RefreshTokenValidity: !Ref userpoolClientRefreshTokenValidity
      UserPoolId: !Ref UserPool
    DependsOn: UserPool

  UserPoolClient:
    Type: AWS::Cognito::UserPoolClient
    Properties:
      ClientName: photosb143529b_app_client
      GenerateSecret: !Ref userpoolClientGenerateSecret
      RefreshTokenValidity: !Ref userpoolClientRefreshTokenValidity
      UserPoolId: !Ref UserPool
    DependsOn: UserPool

  # ---------------------------------------------------------
  # Role for the custom resource Lambda
  # Name pattern: upClientLambdaRole-<shortStackToken>-<env>-<shortGuid>
  # ---------------------------------------------------------
  UserPoolClientRole:
    Type: AWS::IAM::Role
    Properties:
      RoleName: !Join
        - '-'
        - - 'upClientLambdaRole'
          - !Select [3, !Split ['-', !Ref 'AWS::StackName']]
          - !Ref env
          - !Select
              - 0
              - !Split
                - '-'
                - !Select [3, !Split ['/', !Ref 'AWS::StackId']]
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - lambda.amazonaws.com
            Action:
              - 'sts:AssumeRole'
    DependsOn: UserPoolClient

  # ---------------------------------------------------------
  # Python custom resource Lambda (replaces old Node inline)
  # ---------------------------------------------------------
  UserPoolClientLambda:
    Type: AWS::Lambda::Function
    Properties:
      Runtime: python3.11
      Handler: index.handler
      Timeout: 300
      Role: !GetAtt [UserPoolClientRole, Arn]
      Code:
        ZipFile: |
          import json
          import urllib.request
          import boto3

          identity = boto3.client('cognito-idp')

          def send_response(event, context, status, data=None, reason=None, physical_id=None):
            body = {
              "Status": status,
              "Reason": reason or f"See CloudWatch Log Stream: {getattr(context, 'log_stream_name', 'unknown')}",
              "PhysicalResourceId": physical_id or getattr(context, 'log_stream_name', 'custom-resource'),
              "StackId": event["StackId"],
              "RequestId": event["RequestId"],
              "LogicalResourceId": event["LogicalResourceId"],
              "Data": data or {}
            }
            blob = json.dumps(body).encode("utf-8")
            req = urllib.request.Request(
              url=event["ResponseURL"],
              data=blob,
              method="PUT",
              headers={"content-type": "", "content-length": str(len(blob))}
            )
            with urllib.request.urlopen(req):
              pass

          def handler(event, context):
            try:
              req_type = event.get("RequestType")
              if req_type == "Delete":
                send_response(event, context, "SUCCESS", {})
                return
              if req_type in ("Create", "Update"):
                props = event.get("ResourceProperties", {})
                res = identity.describe_user_pool_client(
                  ClientId=props["clientId"],
                  UserPoolId=props["userpoolId"]
                )
                secret = res.get("UserPoolClient", {}).get("ClientSecret", "")
                send_response(event, context, "SUCCESS", {"appSecret": secret})
                return
              send_response(event, context, "FAILED", {}, "Unsupported RequestType")
            except Exception as e:
              send_response(event, context, "FAILED", {}, str(e))
    DependsOn: UserPoolClientRole

  # ---------------------------------------------------------
  # Policies for the custom resource role
  # ---------------------------------------------------------
  UserPoolClientLambdaPolicy:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: photosb143529b_userpoolclient_lambda_iam_policy
      Roles:
        - !Ref UserPoolClientRole
      PolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Action:
              - 'cognito-idp:DescribeUserPoolClient'
            Resource: "*"   # DescribeUserPoolClient requires "*"
    DependsOn: UserPoolClientLambda

  UserPoolClientLogPolicy:
    Type: 'AWS::IAM::Policy'
    Properties:
      PolicyName: photosb143529b_userpoolclient_lambda_log_policy
      Roles:
        - !Ref UserPoolClientRole
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action:
              - 'logs:CreateLogGroup'
              - 'logs:CreateLogStream'
              - 'logs:PutLogEvents'
            Resource: !Sub
              - arn:aws:logs:${region}:${account}:log-group:/aws/lambda/${lambda}:log-stream:*
              - { region: !Ref "AWS::Region",  account: !Ref "AWS::AccountId", lambda: !Ref UserPoolClientLambda }
    DependsOn: UserPoolClientLambdaPolicy

  # ---------------------------------------------------------
  # Invoke the custom resource to fetch ClientSecret
  # ---------------------------------------------------------
  UserPoolClientInputs:
    Type: 'Custom::LambdaCallout'
    Properties:
      ServiceToken: !GetAtt UserPoolClientLambda.Arn
      clientId: !Ref UserPoolClient
      userpoolId: !Ref UserPool
    DependsOn: UserPoolClientLogPolicy

  # ---------------------------------------------------------
  # Identity Pool and role attachment
  # ---------------------------------------------------------
  IdentityPool:
    Type: AWS::Cognito::IdentityPool
    Properties:
      IdentityPoolName: !If
        - ShouldNotCreateEnvResources
        - 'photoshareb143529b_identitypool_b143529b'
        - !Join ['',['photoshareb143529b_identitypool_b143529b', '__', !Ref env]]
      CognitoIdentityProviders:
        - ClientId:  !Ref UserPoolClient
          ProviderName: !Sub 'cognito-idp.${AWS::Region}.amazonaws.com/${UserPool}'
        - ClientId:  !Ref UserPoolClientWeb
          ProviderName: !Sub 'cognito-idp.${AWS::Region}.amazonaws.com/${UserPool}'
      AllowUnauthenticatedIdentities: !Ref allowUnauthenticatedIdentities
    DependsOn: UserPoolClientInputs

  IdentityPoolRoleMap:
    Type: AWS::Cognito::IdentityPoolRoleAttachment
    Properties:
      IdentityPoolId: !Ref IdentityPool
      Roles:
        unauthenticated: !Ref unauthRoleArn
        authenticated: !Ref authRoleArn
    DependsOn: IdentityPool

Outputs:
  IdentityPoolId:
    Value: !Ref 'IdentityPool'
    Description: Id for the identity pool
  IdentityPoolName:
    Value: !GetAtt IdentityPool.Name
  UserPoolId:
    Value: !Ref 'UserPool'
    Description: Id for the user pool
  UserPoolName:
    Value: !Ref userPoolName
  AppClientIDWeb:
    Value: !Ref 'UserPoolClientWeb'
    Description: The user pool app client id for web
  AppClientID:
    Value: !Ref 'UserPoolClient'
    Description: The user pool app client id
  AppClientSecret:
    Value: !GetAtt UserPoolClientInputs.appSecret
